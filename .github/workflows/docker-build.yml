# GitHub Actions workflow for building and pushing Docker images
# Triggers on push to main branch or version tags

name: Build and Push Docker Images

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      tag:
        description: 'Image tag to use'
        required: false
        default: 'latest'

env:
  REGISTRY: docker.io
  # Uses DOCKERHUB_USERNAME secret, fallback to 'magoneai'
  DOCKER_NAMESPACE: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  # ============================================
  # Build API Image
  # ============================================
  build-api:
    name: Build API Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/magoneai-api
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.event.inputs.tag }},enable=${{ github.event_name == 'workflow_dispatch' }}

      - name: Build and push API image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Build Worker Image
  # ============================================
  build-worker:
    name: Build Worker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/magoneai-worker
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.event.inputs.tag }},enable=${{ github.event_name == 'workflow_dispatch' }}

      - name: Build and push Worker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.worker
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Build Web Image
  # ============================================
  build-web:
    name: Build Web Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/magoneai-web
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.event.inputs.tag }},enable=${{ github.event_name == 'workflow_dispatch' }}

      - name: Build and push Web image
        uses: docker/build-push-action@v6
        with:
          context: ./web
          file: ./web/Dockerfile
          platforms: linux/amd64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_API_URL=
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Create Release (on tag push)
  # ============================================
  release:
    name: Create Release
    needs: [build-api, build-worker, build-web]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          body: |
            ## Docker Images

            Pull the images:
            ```bash
            docker pull ${{ env.DOCKER_NAMESPACE }}/magoneai-api:${{ github.ref_name }}
            docker pull ${{ env.DOCKER_NAMESPACE }}/magoneai-worker:${{ github.ref_name }}
            docker pull ${{ env.DOCKER_NAMESPACE }}/magoneai-web:${{ github.ref_name }}
            ```

            ## Quick Start

            ```bash
            # Clone and navigate to deploy folder
            git clone https://github.com/${{ github.repository }}.git
            cd magoneai_v2/deploy

            # Configure environment
            cp .env.example .env
            # Edit .env with your settings

            # Set image tag
            export IMAGE_TAG=${{ github.ref_name }}

            # Start services
            docker-compose up -d
            ```

  # ============================================
  # Deploy to GCP Server
  # ============================================
  deploy:
    name: Deploy to GCP
    needs: [build-api, build-worker, build-web]
    if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect changes

      - name: Determine image tag
        id: tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${{ github.ref_name }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="latest"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Check if docker-compose.yml changed
        id: compose_changed
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q "^deploy/docker-compose.yml$"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "docker-compose.yml has changes - will copy to server"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "docker-compose.yml unchanged - will only update images"
          fi

      - name: Setup SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.GCP_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.GCP_SERVER_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Copy docker-compose.yml to server
        if: steps.compose_changed.outputs.changed == 'true'
        env:
          SSH_USER: ${{ secrets.GCP_SSH_USER }}
          SERVER_IP: ${{ secrets.GCP_SERVER_IP }}
          DEPLOY_PATH: ${{ secrets.GCP_DEPLOY_PATH }}
        run: |
          echo "Copying docker-compose.yml to server..."
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            deploy/docker-compose.yml \
            ${SSH_USER}@${SERVER_IP}:${DEPLOY_PATH}/docker-compose.yml
          echo "docker-compose.yml copied successfully"

      - name: Deploy to GCP server
        env:
          SSH_USER: ${{ secrets.GCP_SSH_USER }}
          SERVER_IP: ${{ secrets.GCP_SERVER_IP }}
          DEPLOY_PATH: ${{ secrets.GCP_DEPLOY_PATH }}
          IMAGE_TAG: ${{ steps.tag.outputs.tag }}
          COMPOSE_CHANGED: ${{ steps.compose_changed.outputs.changed }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${SSH_USER}@${SERVER_IP} << ENDSSH
          set -e

          echo "Starting deployment..."
          cd ${DEPLOY_PATH}

          # Update IMAGE_TAG in .env file
          echo "Setting IMAGE_TAG=${IMAGE_TAG}..."
          if grep -q "^IMAGE_TAG=" .env; then
            sed -i "s/^IMAGE_TAG=.*/IMAGE_TAG=${IMAGE_TAG}/" .env
          else
            echo "IMAGE_TAG=${IMAGE_TAG}" >> .env
          fi

          # Pull new images
          echo "Pulling images (tag: ${IMAGE_TAG})..."
          docker-compose pull

          # Restart services based on whether compose file changed
          if [ "${COMPOSE_CHANGED}" = "true" ]; then
            echo "docker-compose.yml changed - restarting all services..."
            docker-compose down
            docker-compose up -d --remove-orphans
          else
            echo "Rolling restart with new images..."
            docker-compose stop api && docker-compose rm -f api && docker-compose up -d api
            sleep 10
            docker-compose stop worker && docker-compose rm -f worker && docker-compose up -d worker
            sleep 5
            docker-compose stop web && docker-compose rm -f web && docker-compose up -d web
          fi

          # Cleanup old images
          echo "Cleaning up old images..."
          docker image prune -f

          echo "Deployment complete!"
          docker-compose ps
          ENDSSH

      - name: Health check
        env:
          DOMAIN: ${{ secrets.GCP_DOMAIN }}
        run: |
          echo "Running health check..."
          sleep 30

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${DOMAIN}/health || echo "000")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "API is healthy (HTTP $HTTP_STATUS)"
          else
            echo "API health check returned HTTP $HTTP_STATUS"
            exit 1
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "=================================="
          echo "Deployment Summary"
          echo "=================================="
          echo "Image Tag: ${{ steps.tag.outputs.tag }}"
          echo "Compose Changed: ${{ steps.compose_changed.outputs.changed }}"
          echo "Status: ${{ job.status }}"
          echo "=================================="
