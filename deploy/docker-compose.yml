# MagOneAI Production Docker Compose
# Uses Traefik for reverse proxy with path-based routing
#
# Usage:
#   docker-compose -f deploy/docker-compose.yml up -d
#
# Environment variables required:
#   - DOMAIN (e.g., app.magoneai.com)
#   - DB_PASSWORD
#   - SECRET_KEY
#   - OPENAI_API_KEY or ANTHROPIC_API_KEY
#
# Optional:
#   - ACME_EMAIL (for Let's Encrypt)
#   - IMAGE_TAG (defaults to 'latest')

services:
  # ============================================
  # Traefik - Reverse Proxy & Load Balancer
  # ============================================
  traefik:
    image: traefik:v3.2
    container_name: magone-traefik
    restart: unless-stopped
    command:
      # API and Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=false"
      # Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=magone-network"
      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # HTTP to HTTPS redirect
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      # Let's Encrypt (uncomment for production with valid domain)
      # - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      # - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      # - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      # Logging
      - "--log.level=INFO"
      - "--accesslog=true"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "traefik_letsencrypt:/letsencrypt"
    networks:
      - magone-network
    labels:
      # Dashboard (optional - access via traefik.${DOMAIN})
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls=true"
      # Basic auth for dashboard (generate with: htpasswd -nb admin password)
      - "traefik.http.routers.traefik.middlewares=traefik-auth"
      - "traefik.http.middlewares.traefik-auth.basicauth.users=${TRAEFIK_DASHBOARD_AUTH:-admin:$$apr1$$xyz$$placeholder}"

  # ============================================
  # PostgreSQL - Primary Database
  # ============================================
  postgres:
    image: postgres:16-alpine
    container_name: magone-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: magone
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: magone_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    networks:
      - magone-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U magone -d magone_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # Redis - Caching & Sessions
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: magone-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis_secret}
    volumes:
      - redis_data:/data
    networks:
      - magone-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redis_secret}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # Qdrant - Vector Database for RAG
  # ============================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: magone-qdrant
    restart: unless-stopped
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - magone-network
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334

  # ============================================
  # Temporal Server - Workflow Orchestration
  # ============================================
  temporal:
    image: temporalio/auto-setup:latest
    container_name: magone-temporal
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=magone
      - POSTGRES_PWD=${DB_PASSWORD}
      - POSTGRES_SEEDS=postgres
      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development.yaml
    volumes:
      - ./temporal-config:/etc/temporal/config/dynamicconfig:ro
    networks:
      - magone-network

  # ============================================
  # Temporal UI - Workflow Monitoring
  # ============================================
  temporal-ui:
    image: temporalio/ui:latest
    container_name: magone-temporal-ui
    restart: unless-stopped
    depends_on:
      - temporal
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=https://${DOMAIN:-localhost}
    networks:
      - magone-network
    labels:
      - "traefik.enable=true"
      # Route: /temporal/* -> Temporal UI
      - "traefik.http.routers.temporal.rule=Host(`${DOMAIN:-localhost}`) && PathPrefix(`/temporal`)"
      - "traefik.http.routers.temporal.entrypoints=websecure"
      - "traefik.http.routers.temporal.tls=true"
      - "traefik.http.routers.temporal.service=temporal"
      - "traefik.http.services.temporal.loadbalancer.server.port=8080"
      # Strip /temporal prefix
      - "traefik.http.routers.temporal.middlewares=temporal-strip"
      - "traefik.http.middlewares.temporal-strip.stripprefix.prefixes=/temporal"

  # ============================================
  # MagOneAI API - FastAPI Backend
  # ============================================
  api:
    image: ${DOCKER_REGISTRY:-magoneai}/magoneai-api:${IMAGE_TAG:-latest}
    container_name: magone-api
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      temporal:
        condition: service_started
      qdrant:
        condition: service_started
    environment:
      # Application
      APP_ENV: production
      APP_DEBUG: "false"
      # Database
      DATABASE_URL: postgresql+asyncpg://magone:${DB_PASSWORD}@postgres:5432/magone_db
      # Temporal
      TEMPORAL_HOST: temporal:7233
      TEMPORAL_NAMESPACE: default
      TEMPORAL_TASK_QUEUE: agent-tasks
      # Redis
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis_secret}@redis:6379/0
      # Qdrant
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
      # LLM Providers
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      # Security
      SECRET_KEY: ${SECRET_KEY}
      SECRETS_ENCRYPTION_KEY: ${SECRETS_ENCRYPTION_KEY:-}
      # OAuth (optional)
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      OAUTH_REDIRECT_URI: https://${DOMAIN:-localhost}/api/v1/oauth/google/callback
    networks:
      - magone-network
    labels:
      - "traefik.enable=true"
      # Route: /api/* -> API
      - "traefik.http.routers.api.rule=Host(`${DOMAIN:-localhost}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls=true"
      - "traefik.http.routers.api.service=api"
      - "traefik.http.services.api.loadbalancer.server.port=8000"
      # Health endpoint (no /api prefix strip needed as API already uses /api)
      - "traefik.http.routers.api-health.rule=Host(`${DOMAIN:-localhost}`) && Path(`/health`)"
      - "traefik.http.routers.api-health.entrypoints=websecure"
      - "traefik.http.routers.api-health.tls=true"
      - "traefik.http.routers.api-health.service=api"

  # ============================================
  # MagOneAI Worker - Temporal Workflow Worker
  # ============================================
  worker:
    image: ${DOCKER_REGISTRY:-magoneai}/magoneai-worker:${IMAGE_TAG:-latest}
    container_name: magone-worker
    restart: unless-stopped
    depends_on:
      - api
    environment:
      # Database
      DATABASE_URL: postgresql+asyncpg://magone:${DB_PASSWORD}@postgres:5432/magone_db
      # Temporal
      TEMPORAL_HOST: temporal:7233
      TEMPORAL_NAMESPACE: default
      TEMPORAL_TASK_QUEUE: agent-tasks
      # Redis
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis_secret}@redis:6379/0
      # Qdrant
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
      # LLM Providers
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      # Security
      SECRET_KEY: ${SECRET_KEY}
      SECRETS_ENCRYPTION_KEY: ${SECRETS_ENCRYPTION_KEY:-}
    networks:
      - magone-network
    deploy:
      replicas: 2

  # ============================================
  # MagOneAI Web - Next.js Frontend
  # ============================================
  web:
    image: ${DOCKER_REGISTRY:-magoneai}/magoneai-web:${IMAGE_TAG:-latest}
    container_name: magone-web
    restart: unless-stopped
    depends_on:
      - api
    environment:
      NEXT_PUBLIC_API_URL: https://${DOMAIN:-localhost}
    networks:
      - magone-network
    labels:
      - "traefik.enable=true"
      # Route: /* -> Web (lowest priority, catches all other routes)
      - "traefik.http.routers.web.rule=Host(`${DOMAIN:-localhost}`)"
      - "traefik.http.routers.web.entrypoints=websecure"
      - "traefik.http.routers.web.tls=true"
      - "traefik.http.routers.web.service=web"
      - "traefik.http.routers.web.priority=1"
      - "traefik.http.services.web.loadbalancer.server.port=3000"

# ============================================
# Networks
# ============================================
networks:
  magone-network:
    driver: bridge

# ============================================
# Volumes
# ============================================
volumes:
  postgres_data:
  redis_data:
  qdrant_data:
  traefik_letsencrypt:
